# Shared Components for IFrames

All shared source is in `/src/`.

Common webpack plugins are in `/webpack-plugins/`.

Please ensure any new classes are added to `/src/index.ts`, only things exported here will be available on the exported package.

## How to build
```yarn build```

## How to test
```yarn test```

## How to release
Modify the version number for the package you want to release (at the root for iframeshared package, or individual items in webpack-plugins).

After a successful merge into master, automated builds with publishing steps for the modified packages will be triggered.

## How to use this in your own iframe
### Setup
1) Add the `authenticateNPM.cmd` and `.npmrc` files from the `/iframescripts` directory to the root of your project (where `package.json` resides)
2) Add `"appinsights-iframe-shared": "1.0.3"` to the dependencies in your `package.json` file. Replace the version number with the latest you wish to take.
3) Reference the package in your code like so: `import { TooltipService } from 'appinsights-iframe-shared';`
### Local devbox use
1) Run `authenticateNPM` before `npm install` or `yarn`. You only need to do this once.
2) Run `npm install` or `yarn` as you did before to install all dependencies
### Build server use (yarn)
1) Visit https://msazure.visualstudio.com/One/MGMT-AppInsights-Green/_packaging?feed=ApplicationInsights-Team&_a=feed and click `Connect to feed`
2) Under `npm` select `generate npm credentials`. Copy the resulting token (it should begin with //msazure.pkgs.visualstudio.com)
3) In your build configuration, create a protected variable named `yarnAuthenticationToken` with the value being your token.
4) Remove your existing "install dependencies" build step, that runs `yarn`.
5) Replace the build step with the `Authenticated Yarn` task group (you can search for this in "Add Task")
6) When configuring the task, the value for `arguments` should be `install`, and the value for `authToken` should be `$(yarnAuthenticationToken)`
### Build server use (npm)
1) Ensure the `npm install` task for your build definition is version `1.*` (or greater).
2) Ensure the `npm install` task under `custom registries and authentication` is set to use `registries in my .npmrc`

## How to test changes in IFrameShared in your own iframe
1) increment a version in package.json
2) yarn build
3) yarn pack
4) copy the provided .tgz file to your iframe root directory:
copy appinsights-iframe-shared-v1.0.48.tgz ..\Curated\src\
5) switch to your iframe
6) modify "appinsights-iframe-shared" dependency in your iframe to directly point to a file:
"appinsights-iframe-shared": "file:./appinsights-iframe-shared-v1.0.48.tgz"
7) yarn install
8) yarn start

### Testing further changes in IFrameShared in your iframe
1. Modify your iframe's `package.json` to point back to a remote version (e.g. `"1.0.47"`)
2. `yarn cache clean; yarn install` to clear your previous local `.tgz` file from Yarn's cache
3. Follow the instructions above to generate and use a new `.tgz` file with your next code change

### Hot-reloading IFrameShared into your iframe
Modify the `alias` section in `webpack-common.config.js` to reference your local copy of IFrameShared whenever `yarn build` is run, e.g.:
```
alias: {
    'src': 'src/components',
    'appinsights-iframe-shared': 'D:/InsightsPortal-IFrameShared/out'
}
```
